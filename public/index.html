<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>tap-raser</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!--<script src="/socket.io/socket.io.js"></script>-->
    <script src="three.min.js"></script>
    <script>
        var scene=new THREE.Scene();

        var camera=new THREE.OrthographicCamera(-5,5,5,-5,1,100);
        //var camera=new THREE.PerspectiveCamera(45,1,1,100);
        camera.position.set(0,0,10);

        var renderer=new THREE.WebGLRenderer();
        renderer.setSize(500,500);
        renderer.setClearColor(0xeeeeee);
        document.body.appendChild(renderer.domElement);
        
        
        var texture=new THREE.TextureLoader().load('./zero.jpg',function(){
            renderer.render(scene,camera);
        });
        var geometry=new THREE.SphereGeometry(0.5,10,10);
        var geometry=new THREE.BoxGeometry(1,1,1);
        var material=new THREE.MeshLambertMaterial({map:texture});
        var ball=new THREE.Mesh(geometry,material);
        ball.matrixAutoUpdate = false; 
        
        
        
        
        var back=new THREE.TextureLoader().load('./back.jpg',function(){
            renderer.render(scene,camera);
        });
        back.wrapS = back.wrapT = THREE.RepeatWrapping;
        back.repeat.set(4,4);
        var planegeo=new THREE.PlaneGeometry(10,10);
        var planematerial=new THREE.MeshLambertMaterial({map:back});
        var plane=new THREE.Mesh(planegeo,planematerial);
        plane.position.z=-10;
        
        //var light=new THREE.AmbientLight(0xeeeeee);
        var light = new THREE.SpotLight(0xffffff, 2, 100,Math.PI / 6);
        light.position.set(0, 0, 8);
        light.target.position.set(0,0,0);
        //light.target=ball;

        scene.add(light);
        scene.add(ball);
        scene.add(plane);
        renderer.render(scene,camera);
        
        var distance=0.1;                
        document.onkeydown=function(e_keydown){
            new Promise(function(resolve,reject){
                document.onkeyup=function(e_keyup){
                    if(e_keydown.keyCode===e_keyup.keyCode){
                        switch(e_keydown.keyCode){
                            case 38:
                                //socket.emit('up');
                                roll({x:0,y:distance});
                                break;
                            case 40:
                                //socket.emit('down');
                                roll({x:0,y:-distance});
                                break;
                            case 37:
                                //socket.emit('left');
                                roll({x:-distance,y:0});
                                break;
                            case 39:
                                //socket.emit('right');
                                roll({x:distance,y:0});
                                break;
                        }
                        resolve();
                    }
                }
            });
        }
        
        function roll(position){
            var step=0.01;//每次移动的距离
            var x=position.x;
            var y=position.y;
            var dis=Math.sqrt(x*x+y*y);
            var times=Math.floor(dis/step);
            var dx=x/times;
            var dy=y/times;
            
            var degree=step/0.5;

            var quaternion = new THREE.Quaternion();
            quaternion=ball.quaternion;//获取物体的四元数
            
            var dquaternoin = new THREE.Quaternion();
            dquaternoin=dquaternoin.setFromAxisAngle( new THREE.Vector3( -y, x, 0 ).normalize(), degree );//增量四元数
            
            var vector=new THREE.Vector3();
            vector=ball.position;//获取物体的位置
            var dvector=new THREE.Vector3(dx,dy,0);//增量向量
            

            var id;
            function draw(){
                times--;
                
                quaternion.multiplyQuaternions(dquaternoin,quaternion);
                ball.matrix.makeRotationFromQuaternion(quaternion);
                
                vector.addVectors(vector,dvector);
                ball.matrix.setPosition(vector);
                
                renderer.render(scene,camera);
                id=requestAnimationFrame(draw);
                if(times<0){cancelAnimationFrame(id);id=null}
            }
            draw();
        }
        //roll({x:-2,y:-2},{x:2,y:2});
        
        // var socket=io.connect();
        // socket.on('position',function(position){
        //     ball.position.x=position.x;
        //     ball.position.y=position.y;
        //     ball.position.z=position.z;
        //     renderer.render(scene,camera);
        // });
    </script>
</body>
</html>